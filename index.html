<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0a0a">
<title>CS Kettlebell EMOM Timer</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚è±</text></svg>">
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:#0a0a0a;font-family:'JetBrains Mono','SF Mono','Fira Code','Courier New',monospace;-webkit-tap-highlight-color:transparent;overflow-x:hidden}
  ::-webkit-scrollbar{display:none}
  input:focus,button:focus{outline:none}
  button{font-family:inherit}
</style>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useRef,useCallback}=React;

/* ‚îÄ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ */
const STORE_EX="emom-exercises",STORE_WK="emom-saved-workouts",STORE_LOGS="emom-logs",STORE_FAVS="emom-favorites",STORE_MUTE="emom-muted";
const DEF_REPS=10,DEF_WEIGHT=12;
const DEF_EXERCISES=["Two-hand swing","One-hand swing","Deadlift","Clean","Goblet squat","Double kettlebell front squat","Split squat","Bulgarian split squat","Strict overhead press","Push press","Floor press","Farmer carry","Suitcase carry","Rack carry","Overhead carry","Snatch","High pull","Clean and press","Thruster","Bent-over row","Renegade row","Gorilla row","Turkish get-up","Windmill","Russian twist","Halo","Lunges","Reverse lunges","Alternating swing","Complex combinations"];
const pl=(n,w)=>`${n} ${w}${n===1?"":"s"}`;
const store={get:k=>{try{return JSON.parse(localStorage.getItem(k))}catch{return null}},set:(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}}};
const vibrate=(ms=10)=>{try{navigator.vibrate&&navigator.vibrate(ms)}catch{}};
function timeOfDay(d){const h=d.getHours();return h<12?"Morning":h<17?"Afternoon":"Evening"}
function fmtDate(d){const mm=d.getMonth()+1,dd=d.getDate(),yy=d.getFullYear();let hh=d.getHours(),ap="AM";if(hh>=12){ap="PM";if(hh>12)hh-=12}if(hh===0)hh=12;const mn=d.getMinutes().toString().padStart(2,"0");return`${mm}/${dd}/${yy} ${hh}:${mn}${ap}`}
function fmtElapsed(s){const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60;if(h>0)return`${h}:${m.toString().padStart(2,"0")}:${sec.toString().padStart(2,"0")}`;return`${m}:${sec.toString().padStart(2,"0")}`}
function fmt(s){return`${Math.floor(s/60)}:${(s%60).toString().padStart(2,"0")}`}

/* ‚îÄ‚îÄ‚îÄ HOOKS ‚îÄ‚îÄ‚îÄ */
function useExerciseLibrary(){
  const[library,setLibrary]=useState(()=>{const c=store.get(STORE_EX);if(c&&Array.isArray(c)){const m=[...DEF_EXERCISES];c.forEach(x=>{if(!m.some(e=>e.toLowerCase()===x.toLowerCase()))m.push(x)});return m}return[...DEF_EXERCISES]});
  const addExercise=useCallback(name=>{const t=name.trim();if(!t)return;setLibrary(prev=>{if(prev.some(e=>e.toLowerCase()===t.toLowerCase()))return prev;const next=[...prev,t];store.set(STORE_EX,next.filter(n=>!DEF_EXERCISES.some(d=>d.toLowerCase()===n.toLowerCase())));return next})},[]);
  return{library,addExercise};
}
function useSavedWorkouts(){
  const[workouts,setWorkouts]=useState(()=>store.get(STORE_WK)||[]);
  const saveWorkout=useCallback((name,exercises)=>setWorkouts(p=>{const n=[...p,{id:Date.now(),name,exercises}];store.set(STORE_WK,n);return n}),[]);
  const deleteWorkout=useCallback(id=>setWorkouts(p=>{const n=p.filter(w=>w.id!==id);store.set(STORE_WK,n);return n}),[]);
  return{workouts,saveWorkout,deleteWorkout};
}
function useLogs(){
  const[logs,setLogs]=useState(()=>store.get(STORE_LOGS)||[]);
  const addLog=useCallback(entry=>{setLogs(p=>{const n=[entry,...p];store.set(STORE_LOGS,n);return n})},[]);
  const deleteLog=useCallback(id=>{setLogs(p=>{const n=p.filter(l=>l.id!==id);store.set(STORE_LOGS,n);return n})},[]);
  const resetAll=useCallback(()=>{setLogs([]);store.set(STORE_LOGS,[])},[]);
  return{logs,addLog,deleteLog,resetAll};
}
function useFavorites(){
  const[favs,setFavs]=useState(()=>store.get(STORE_FAVS)||[]);
  const toggle=useCallback(name=>{setFavs(p=>{const n=p.includes(name)?p.filter(f=>f!==name):[...p,name];store.set(STORE_FAVS,n);return n})},[]);
  return{favs,toggle};
}
function useSwipeBack(onBack){
  const ref=useRef(null);
  useEffect(()=>{
    const el=ref.current;if(!el)return;
    let sx=0,sy=0,tracking=false;
    const ts=e=>{const t=e.touches[0];if(t.clientX<40){sx=t.clientX;sy=t.clientY;tracking=true}};
    const tm=e=>{if(!tracking)return;const t=e.touches[0];const dx=t.clientX-sx,dy=Math.abs(t.clientY-sy);if(dx>80&&dy<50){tracking=false;onBack()}};
    const te=()=>{tracking=false};
    el.addEventListener("touchstart",ts,{passive:true});
    el.addEventListener("touchmove",tm,{passive:true});
    el.addEventListener("touchend",te,{passive:true});
    return()=>{el.removeEventListener("touchstart",ts);el.removeEventListener("touchmove",tm);el.removeEventListener("touchend",te)};
  },[onBack]);
  return ref;
}

/* ‚îÄ‚îÄ‚îÄ CONFIRM MODAL ‚îÄ‚îÄ‚îÄ */
function ConfirmModal({title,message,confirmText="Confirm",confirmColor="#ef4444",onConfirm,onCancel}){
  return(<div style={S.overlay}><div style={S.modal}>
    <h3 style={S.modalTitle}>{title}</h3>
    <p style={{textAlign:"center",color:"#a3a3a3",fontSize:14,margin:"0 0 20px",lineHeight:1.6}}>{message}</p>
    <div style={{display:"flex",gap:8}}>
      <button onClick={onCancel} style={{...S.modalBtn,flex:1,marginTop:0}}>Cancel</button>
      <button onClick={onConfirm} style={{...S.modalBtn,flex:1,marginTop:0,background:confirmColor,color:"#fff",fontWeight:700}}>{confirmText}</button>
    </div>
  </div></div>);
}

function NumInput({value,onChange,max,label}){
  const h=e=>{const r=e.target.value.replace(/[^0-9]/g,"");if(r===""){onChange(0);return}onChange(Math.min(parseInt(r,10),max))};
  return(<div style={{flex:1}}><label style={S.editLabel}>{label}</label><input type="text" inputMode="numeric" pattern="[0-9]*" value={String(value)} onChange={h} style={{...S.input,textAlign:"center",fontSize:18,fontWeight:700}}/></div>);
}

function EditExerciseModal({exercise,onSave,onCancel}){
  const[reps,setReps]=useState(exercise.reps);const[weight,setWeight]=useState(exercise.weight);
  return(<div style={S.overlay}><div style={S.modal}>
    <h3 style={S.modalTitle}>Edit Exercise</h3>
    <p style={{textAlign:"center",color:"#eab308",fontSize:14,fontWeight:600,margin:"0 0 16px"}}>{exercise.name}</p>
    <div style={{display:"flex",gap:12,marginBottom:16}}><NumInput value={reps} onChange={setReps} max={99} label="Reps"/><NumInput value={weight} onChange={setWeight} max={99} label="Weight (kg)"/></div>
    <div style={{display:"flex",gap:8}}>
      <button onClick={onCancel} style={{...S.modalBtn,flex:1,marginTop:0}}>Cancel</button>
      <button onClick={()=>onSave({reps,weight})} style={{...S.modalBtn,flex:1,marginTop:0,background:"#eab308",color:"#0a0a0a",fontWeight:700}}>Save</button>
    </div>
  </div></div>);
}

/* ‚îÄ‚îÄ‚îÄ SCROLL PICKER (fixed spacers for 0/max alignment + haptic) ‚îÄ‚îÄ‚îÄ */
function ScrollPicker({value,onChange,max=20,suffix}){
  const ref=useRef(null);const H=36;const lastSnap=useRef(value);
  useEffect(()=>{const el=ref.current;if(!el)return;el.scrollTop=value*H;const t1=setTimeout(()=>{el.scrollTop=value*H},50);const t2=setTimeout(()=>{el.scrollTop=value*H},150);return()=>{clearTimeout(t1);clearTimeout(t2)}},[]);
  useEffect(()=>{if(ref.current){const c=Math.round(ref.current.scrollTop/H);if(c!==value)ref.current.scrollTo({top:value*H,behavior:"smooth"})}},[value]);
  const handleScroll=()=>{if(!ref.current)return;const c=Math.max(0,Math.min(max,Math.round(ref.current.scrollTop/H)));if(c!==value){if(c!==lastSnap.current){lastSnap.current=c;vibrate(10)}onChange(c)}};
  const snap=i=>ref.current?.scrollTo({top:i*H,behavior:"smooth"});
  return(
    <div style={{position:"relative",width:80,height:120,flexShrink:0}}>
      <div style={{position:"absolute",top:"50%",left:2,right:2,height:38,transform:"translateY(-50%)",border:"2px solid #eab308",borderRadius:8,pointerEvents:"none",zIndex:1}}/>
      <div style={{position:"absolute",top:0,left:0,right:0,height:36,background:"linear-gradient(to bottom,#0a0a0a,transparent)",pointerEvents:"none",zIndex:1}}/>
      <div style={{position:"absolute",bottom:0,left:0,right:0,height:36,background:"linear-gradient(to top,#0a0a0a,transparent)",pointerEvents:"none",zIndex:1}}/>
      <div ref={ref} onScroll={handleScroll} style={{height:"100%",overflowY:"scroll",scrollSnapType:"y mandatory",WebkitOverflowScrolling:"touch",scrollbarWidth:"none",msOverflowStyle:"none"}}>
        <div style={{height:H*1.5}}/>
        {Array.from({length:max+1},(_,i)=>(
          <div key={i} onClick={()=>snap(i)} style={{height:H,display:"flex",alignItems:"center",justifyContent:"center",scrollSnapAlign:"center",cursor:"pointer",userSelect:"none",color:i===value?"#eab308":"#555",fontWeight:i===value?800:400,fontSize:i===value?20:14,transition:"all 0.12s",fontFamily:"inherit",gap:4}}>
            {i}{i===value&&suffix?<span style={{fontSize:11,color:"#999",fontWeight:600}}>{suffix}</span>:null}
          </div>
        ))}
        <div style={{height:H*1.5}}/>
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ‚îÄ EXERCISE DROPDOWN (with favorites) ‚îÄ‚îÄ‚îÄ */
function ExerciseDropdown({value,onChange,library,onCustomAdd,favs,toggleFav}){
  const[open,setOpen]=useState(false);const[filter,setFilter]=useState("");const ref=useRef(null);
  useEffect(()=>{const h=e=>{if(ref.current&&!ref.current.contains(e.target))setOpen(false)};document.addEventListener("mousedown",h);return()=>document.removeEventListener("mousedown",h)},[]);
  const filtered=library.filter(e=>e.toLowerCase().includes(filter.toLowerCase()));
  // Sort: favorites first, then rest
  const sorted=[...filtered].sort((a,b)=>{const af=favs.includes(a)?0:1,bf=favs.includes(b)?0:1;return af-bf});
  const hasFavs=sorted.some(e=>favs.includes(e));
  return(
    <div ref={ref} style={{position:"relative",flex:1,minWidth:0}}>
      <button onClick={()=>setOpen(!open)} style={{...S.input,cursor:"pointer",textAlign:"left",display:"flex",justifyContent:"space-between",alignItems:"center",color:value?"#fafafa":"#888",fontWeight:value?400:500,height:44}}>
        <span style={{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{value||"Select exercise"}</span>
        <span style={{fontSize:10,color:"#555",marginLeft:8,flexShrink:0}}>{open?"‚ñ≤":"‚ñº"}</span>
      </button>
      {open&&(<div style={S.dropdown}>
        <input type="text" value={filter} placeholder="Search or type new‚Ä¶" onChange={e=>setFilter(e.target.value)} autoFocus style={{...S.input,borderRadius:0,borderBottom:"1px solid #333",position:"sticky",top:0,zIndex:2,background:"#1c1c1c"}}/>
        <div style={{maxHeight:220,overflowY:"auto"}}>
          {sorted.map((ex,i)=>{
            const isFav=favs.includes(ex);
            const showDivider=hasFavs&&i>0&&!isFav&&favs.includes(sorted[i-1]);
            return(<React.Fragment key={ex}>
              {showDivider&&<div style={{height:1,background:"#333",margin:"4px 0"}}/>}
              <div style={{...S.ddItem,background:ex===value?"rgba(234,179,8,0.1)":"transparent",display:"flex",alignItems:"center",justifyContent:"space-between"}}>
                <span style={{flex:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}} onMouseDown={()=>{onChange(ex);setFilter("");setOpen(false)}}>{ex}</span>
                <span onClick={(e)=>{e.stopPropagation();toggleFav(ex)}} style={{cursor:"pointer",fontSize:14,marginLeft:8,opacity:isFav?1:0.3}}>{isFav?"‚òÖ":"‚òÜ"}</span>
              </div>
            </React.Fragment>);
          })}
          {filter.trim()&&!library.some(e=>e.toLowerCase()===filter.trim().toLowerCase())&&(
            <div style={{...S.ddItem,color:"#eab308",fontStyle:"italic"}} onMouseDown={()=>{onCustomAdd(filter.trim());onChange(filter.trim());setFilter("");setOpen(false)}}>+ Add "{filter.trim()}"</div>
          )}
        </div>
      </div>)}
    </div>
  );
}

function IntensityMeter({volume}){
  let pct,color,label;
  if(volume<=0){pct=0;color="#333";label="‚Äî"}
  else if(volume<1000){pct=volume/2000*40;color="#22c55e";label="Light"}
  else if(volume<2000){pct=20+(volume-1000)/1000*20;color="#22c55e";label="Light"}
  else if(volume<2750){pct=40+(volume-2000)/750*20;color="#eab308";label="Moderate"}
  else if(volume<3500){pct=60+(volume-2750)/750*20;color="#f97316";label="Hard"}
  else{pct=Math.min(100,80+(volume-3500)/1500*20);color="#ef4444";label="Intense"}
  return(<div style={{marginTop:8}}>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}}>
      <span style={{fontSize:10,letterSpacing:2,color:"#555",textTransform:"uppercase"}}>Intensity</span>
      <span style={{fontSize:12,fontWeight:700,color}}>{label}</span>
    </div>
    <div style={{height:6,borderRadius:3,background:"#1a1a1a",overflow:"hidden"}}>
      <div style={{height:"100%",borderRadius:3,width:`${pct}%`,background:`linear-gradient(90deg,#22c55e,${color})`,transition:"width 0.4s,background 0.4s"}}/>
    </div>
  </div>);
}

function StatsBar({exercises,sets}){
  const totalTime=exercises.length*sets;const totalVolume=exercises.reduce((s,e)=>s+e.reps*(e.weight||0),0)*sets;
  return(<div style={S.statsBar}>
    <div style={{display:"flex",justifyContent:"center",gap:20,alignItems:"baseline"}}>
      <div style={S.statBlock}><span style={S.statValue}>{totalTime}</span><span style={S.statLabel}>min</span></div>
      <div style={{width:1,height:24,background:"#262626"}}/>
      <div style={S.statBlock}><span style={S.statValue}>{totalVolume.toLocaleString()}</span><span style={S.statLabel}>kg vol</span></div>
    </div>
    <IntensityMeter volume={totalVolume}/>
  </div>);
}

function SetsSelector({sets,onChange}){
  return(<div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:16,marginBottom:12}}>
    <button onClick={()=>onChange(Math.max(1,sets-1))} style={S.setsBtn}>‚àí</button>
    <div style={{textAlign:"center",minWidth:60}}><span style={{fontSize:24,fontWeight:800,color:"#fafafa"}}>{sets}</span><span style={{fontSize:11,color:"#555",letterSpacing:2,display:"block",marginTop:2}}>{sets===1?"SET":"SETS"}</span></div>
    <button onClick={()=>onChange(Math.min(10,sets+1))} style={S.setsBtn}>+</button>
  </div>);
}

function SaveModal({onSave,onCancel}){
  const[name,setName]=useState("");
  return(<div style={S.overlay}><div style={S.modal}>
    <h3 style={S.modalTitle}>Save Workout</h3>
    <input type="text" value={name} onChange={e=>setName(e.target.value)} placeholder="Workout name" autoFocus style={{...S.input,marginBottom:16,width:"100%"}}/>
    <div style={{display:"flex",gap:8}}>
      <button onClick={onCancel} style={{...S.modalBtn,flex:1,marginTop:0}}>Cancel</button>
      <button onClick={()=>name.trim()&&onSave(name.trim())} disabled={!name.trim()} style={{...S.modalBtn,flex:1,marginTop:0,background:name.trim()?"#eab308":"#333",color:name.trim()?"#0a0a0a":"#666",fontWeight:700}}>Save</button>
    </div>
  </div></div>);
}

function LoadModal({workouts,onLoad,onDelete,onCancel}){
  return(<div style={S.overlay}><div style={S.modal}>
    <h3 style={S.modalTitle}>Load Workout</h3>
    {workouts.length===0&&<p style={{textAlign:"center",color:"#666",fontSize:14}}>No saved workouts yet</p>}
    {workouts.map(w=>(<div key={w.id} style={S.loadItem}>
      <div style={{flex:1,cursor:"pointer"}} onClick={()=>onLoad(w)}><span style={{display:"block",fontSize:14,fontWeight:600}}>{w.name}</span><span style={{display:"block",fontSize:12,color:"#737373",marginTop:2}}>{pl(w.exercises.length,"round")}</span></div>
      <button onClick={()=>onDelete(w.id)} style={{...S.microBtn,color:"#ef4444"}}>‚úï</button>
    </div>))}
    <button onClick={onCancel} style={S.modalBtn}>Close</button>
  </div></div>);
}

/* ‚îÄ‚îÄ‚îÄ SCREEN HEADER (with safe area + bigger back button) ‚îÄ‚îÄ‚îÄ */
function ScreenHeader({title,onBack}){
  return(<div style={{paddingTop:"max(16px, env(safe-area-inset-top, 16px))",marginBottom:20}}>
    <div style={{display:"flex",alignItems:"center",gap:12}}>
      <button onClick={onBack} style={{background:"none",border:"1px solid #333",borderRadius:8,color:"#eab308",fontSize:16,cursor:"pointer",padding:"8px 14px",fontWeight:700,fontFamily:"inherit"}}>‚Üê Back</button>
      <h2 style={{fontSize:18,fontWeight:700,letterSpacing:3,color:"#fafafa",textTransform:"uppercase"}}>{title}</h2>
    </div>
  </div>);
}

/* ‚îÄ‚îÄ‚îÄ MENU SCREENS ‚îÄ‚îÄ‚îÄ */
function LogsScreen({logs,deleteLog,onBack}){
  const[expanded,setExpanded]=useState(null);
  const[confirmDel,setConfirmDel]=useState(null);
  const swipeRef=useSwipeBack(onBack);
  return(<div ref={swipeRef} style={S.page}>
    <ScreenHeader title="Workout Logs" onBack={onBack}/>
    {logs.length===0&&<p style={{textAlign:"center",color:"#555",fontSize:14,marginTop:40}}>No workouts logged yet. Complete a workout to see it here.</p>}
    {logs.map(log=>{
      const d=new Date(log.startTime);const name=log.workoutName||`${timeOfDay(d)} Workout`;const isOpen=expanded===log.id;
      return(<div key={log.id} style={{background:"#141414",borderRadius:10,padding:"14px 16px",marginBottom:10}}>
        <div style={{display:"flex",alignItems:"flex-start",justifyContent:"space-between"}}>
          <div style={{flex:1,cursor:"pointer"}} onClick={()=>setExpanded(isOpen?null:log.id)}>
            <span style={{display:"block",fontSize:11,color:"#555"}}>{fmtDate(d)}</span>
            <span style={{display:"flex",alignItems:"center",gap:6,fontSize:14,fontWeight:600,marginTop:4,flexWrap:"wrap"}}>
              {name}
              {log.partial&&<span style={{fontSize:10,color:"#ef4444",fontWeight:700,background:"rgba(239,68,68,0.15)",padding:"2px 6px",borderRadius:4}}>Partial</span>}
            </span>
            <span style={{display:"block",fontSize:12,color:"#737373",marginTop:4}}>{pl(log.completedRounds,"round")} ¬∑ {log.totalVolume.toLocaleString()}kg ¬∑ {fmtElapsed(log.elapsed)}</span>
          </div>
          <div style={{display:"flex",gap:6,alignItems:"center"}}>
            <button onClick={()=>setExpanded(isOpen?null:log.id)} style={{...S.microBtn,fontSize:10}}>{isOpen?"‚ñ≤":"‚ñº"}</button>
            <button onClick={()=>setConfirmDel(log.id)} style={{...S.microBtn,color:"#ef4444"}}>‚úï</button>
          </div>
        </div>
        {isOpen&&(<div style={{marginTop:12,paddingTop:12,borderTop:"1px solid #222"}}>
          {log.exercises.map((ex,i)=>(<div key={i} style={{display:"flex",justifyContent:"space-between",padding:"6px 0",fontSize:13}}>
            <span style={{color:"#a3a3a3"}}>{i+1}. {ex.name}</span>
            <span style={{color:"#737373"}}>{ex.reps}r ¬∑ {ex.weight}kg</span>
          </div>))}
          {log.sets>1&&<div style={{textAlign:"right",fontSize:12,color:"#555",marginTop:4}}>√ó{log.sets} sets</div>}
        </div>)}
      </div>);
    })}
    {confirmDel!==null&&<ConfirmModal title="Delete Log?" message="This will permanently delete this workout log and affect your lifetime stats." onConfirm={()=>{deleteLog(confirmDel);setConfirmDel(null)}} onCancel={()=>setConfirmDel(null)}/>}
  </div>);
}

function StatsScreen({logs,resetAll,onBack}){
  const[sortBy,setSortBy]=useState("volume");
  const[confirmReset,setConfirmReset]=useState(false);
  const swipeRef=useSwipeBack(onBack);
  const totalVol=logs.reduce((s,l)=>s+l.totalVolume,0);
  const totalWorkouts=logs.length;
  const movements={};
  logs.forEach(log=>{
    const roundsToCount=log.completedRounds||0;
    for(let i=0;i<roundsToCount;i++){
      const ex=log.exercises[i%log.exercises.length];
      if(!movements[ex.name])movements[ex.name]={reps:0,volume:0};
      movements[ex.name].reps+=ex.reps;
      movements[ex.name].volume+=ex.reps*(ex.weight||0);
    }
  });
  const sorted=Object.entries(movements).sort((a,b)=>sortBy==="volume"?b[1].volume-a[1].volume:b[1].reps-a[1].reps);
  return(<div ref={swipeRef} style={S.page}>
    <ScreenHeader title="Stats" onBack={onBack}/>
    <div style={{background:"#141414",borderRadius:12,padding:20,textAlign:"center",marginBottom:20}}>
      <div style={{fontSize:10,letterSpacing:3,color:"#555",textTransform:"uppercase",marginBottom:8}}>Lifetime Volume</div>
      <div style={{fontSize:32,fontWeight:800,color:"#eab308"}}>{totalVol.toLocaleString()} kg</div>
      <div style={{fontSize:12,color:"#737373",marginTop:6}}>{pl(totalWorkouts,"workout")} logged</div>
    </div>
    {sorted.length>0&&(<>
      <div style={{display:"flex",gap:8,marginBottom:14}}>
        <button onClick={()=>setSortBy("volume")} style={{...S.sortBtn,background:sortBy==="volume"?"#eab308":"#1a1a1a",color:sortBy==="volume"?"#0a0a0a":"#737373"}}>By Volume</button>
        <button onClick={()=>setSortBy("reps")} style={{...S.sortBtn,background:sortBy==="reps"?"#eab308":"#1a1a1a",color:sortBy==="reps"?"#0a0a0a":"#737373"}}>By Reps</button>
      </div>
      <div style={{background:"#141414",borderRadius:10,overflow:"hidden"}}>
        {sorted.map(([name,data],i)=>(<div key={name} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"12px 16px",borderBottom:i<sorted.length-1?"1px solid #1f1f1f":"none"}}>
          <span style={{fontSize:13,fontWeight:600,color:"#d4d4d4",flex:1}}>{name}</span>
          <span style={{fontSize:12,color:"#eab308",minWidth:70,textAlign:"right"}}>{data.reps.toLocaleString()} reps</span>
          <span style={{fontSize:12,color:"#737373",minWidth:80,textAlign:"right"}}>{data.volume.toLocaleString()}kg</span>
        </div>))}
      </div>
    </>)}
    {sorted.length===0&&<p style={{textAlign:"center",color:"#555",fontSize:14,marginTop:20}}>Complete workouts to see movement stats.</p>}
    <div style={{marginTop:40,textAlign:"center"}}>
      <button onClick={()=>setConfirmReset(true)} style={{background:"none",border:"none",color:"#444",fontSize:12,cursor:"pointer",letterSpacing:1}}>Reset All Data</button>
    </div>
    {confirmReset&&<ConfirmModal title="Reset All Data?" message="This will permanently delete ALL workout logs and stats. This action cannot be undone." confirmText="Reset Everything" onConfirm={()=>{resetAll();setConfirmReset(false)}} onCancel={()=>setConfirmReset(false)}/>}
  </div>);
}

function ReadMeScreen({onBack}){
  const swipeRef=useSwipeBack(onBack);
  return(<div ref={swipeRef} style={S.page}>
    <ScreenHeader title="Read Me" onBack={onBack}/>
    <div style={{color:"#a3a3a3",fontSize:14,lineHeight:2}}>
      <p style={{fontWeight:700,color:"#eab308",marginBottom:12}}>How to use the CS Kettlebell EMOM Timer</p>
      <p><b style={{color:"#d4d4d4"}}>Build your workout.</b> Select an exercise from the dropdown, set your reps and weight using the scroll pickers, and tap + to add it to your round list. Repeat for each exercise in your circuit.</p>
      <p style={{marginTop:12}}><b style={{color:"#d4d4d4"}}>Sets.</b> If you want to repeat your circuit multiple times, increase the sets counter. 5 exercises √ó 4 sets = 20 rounds.</p>
      <p style={{marginTop:12}}><b style={{color:"#d4d4d4"}}>Start.</b> Hit Start and you'll get a 3-second countdown. Each round is 60 seconds. Complete your reps, rest for the remainder, and go again when the beep sounds.</p>
      <p style={{marginTop:12}}><b style={{color:"#d4d4d4"}}>During the workout.</b> Use ‚ü® ‚ü© to skip or go back a round. Pause if you need a break. Double-tap the timer ring to quickly pause or resume. The timer keeps running even if your screen locks.</p>
      <p style={{marginTop:12}}><b style={{color:"#d4d4d4"}}>Save & Load.</b> Save your favorite workouts to reuse them. Your workout history and stats are tracked automatically.</p>
      <p style={{marginTop:12}}><b style={{color:"#d4d4d4"}}>Favorites.</b> Tap the star next to any exercise in the dropdown to pin it to the top of your list.</p>
    </div>
  </div>);
}

function AboutScreen({onBack}){
  const swipeRef=useSwipeBack(onBack);
  return(<div ref={swipeRef} style={S.page}>
    <ScreenHeader title="About" onBack={onBack}/>
    <div style={{textAlign:"center",marginTop:20}}>
      <div style={{fontSize:48,marginBottom:12}}>‚è±</div>
      <h2 style={{fontSize:20,fontWeight:800,color:"#eab308",letterSpacing:4,marginBottom:4}}>CS Kettlebell</h2>
      <h3 style={{fontSize:14,color:"#737373",letterSpacing:2,marginBottom:24}}>EMOM Timer</h3>
      <div style={{color:"#a3a3a3",fontSize:14,lineHeight:1.9,textAlign:"left",maxWidth:360,margin:"0 auto"}}>
        <p>Built by <span style={{color:"#eab308",fontWeight:700}}>clarenceos</span> using <span style={{color:"#d4d4d4",fontWeight:600}}>Claude AI</span>.</p>
        <p style={{marginTop:16}}>I got tired of paying $20 a year for a countdown timer. I just love doing kettlebell EMOMs ‚Äî it's simple, it's effective, and it doesn't need a subscription.</p>
        <p style={{marginTop:16}}>There are more powerful timers out there with more features and broader scope. But if kettlebell EMOMs are your thing, I think this app would probably be very high up on your list.</p>
        <p style={{marginTop:16}}>No ads. No subscriptions. Just you, your kettlebell, and a timer that works.</p>
      </div>
    </div>
  </div>);
}

function MenuOverlay({onNavigate,onClose}){
  const items=[{key:"logs",icon:"üìã",label:"Logs"},{key:"stats",icon:"üìä",label:"Stats"},{key:"readme",icon:"üìñ",label:"Read Me"},{key:"about",icon:"‚ÑπÔ∏è",label:"About"}];
  return(<div style={S.overlay} onClick={onClose}><div style={S.modal} onClick={e=>e.stopPropagation()}>
    <h3 style={S.modalTitle}>Menu</h3>
    {items.map(it=>(<button key={it.key} onClick={()=>onNavigate(it.key)} style={S.menuItem}>
      <span style={{fontSize:18}}>{it.icon}</span><span>{it.label}</span>
    </button>))}
    <button onClick={onClose} style={{...S.modalBtn,marginTop:16}}>Close</button>
  </div></div>);
}

/* ‚îÄ‚îÄ‚îÄ WORKOUT BUILDER ‚îÄ‚îÄ‚îÄ */
function WorkoutBuilder({exercises,setExercises,sets,setSets,onStart,library,addExercise,savedWorkouts,saveWorkout,deleteWorkout,workoutName,setWorkoutName,onNavigate,favs,toggleFav}){
  const[sel,setSel]=useState("");const[reps,setReps]=useState(DEF_REPS);const[weight,setWeight]=useState(DEF_WEIGHT);
  const[showSave,setShowSave]=useState(false);const[showLoad,setShowLoad]=useState(false);const[editIdx,setEditIdx]=useState(null);const[showMenu,setShowMenu]=useState(false);
  const handleAdd=()=>{if(!sel)return;setExercises(prev=>[...prev,{id:Date.now(),name:sel,reps,weight}]);setSel("")};
  const remove=id=>setExercises(prev=>prev.filter(e=>e.id!==id));
  const move=(i,d)=>setExercises(prev=>{const n=[...prev];const j=i+d;if(j<0||j>=n.length)return prev;[n[i],n[j]]=[n[j],n[i]];return n});
  const updateExercise=(idx,u)=>{setExercises(prev=>prev.map((e,i)=>i===idx?{...e,...u}:e));setEditIdx(null)};
  return(
    <div style={S.builder}>
      {/* Safe area + hamburger row */}
      <div style={{paddingTop:"max(8px, env(safe-area-inset-top, 8px))",display:"flex",justifyContent:"flex-end",marginBottom:8}}>
        <button onClick={()=>setShowMenu(true)} style={{background:"none",border:"1px solid #333",borderRadius:8,color:"#a3a3a3",fontSize:18,cursor:"pointer",padding:"6px 10px",lineHeight:1}}>‚ò∞</button>
      </div>
      <div style={S.logoArea}>
        <div style={{fontSize:36,marginBottom:8}}>‚è±</div>
        <h1 style={S.titleMain}>CS Kettlebell</h1>
        <h1 style={S.titleSub}>EMOM Timer</h1>
      </div>
      <div style={{marginBottom:12}}>
        <ExerciseDropdown value={sel} onChange={setSel} library={library} onCustomAdd={addExercise} favs={favs} toggleFav={toggleFav}/>
        <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:12,marginTop:14}}>
          <ScrollPicker key="reps-picker" value={reps} onChange={setReps} max={20} suffix="reps"/>
          <ScrollPicker key="weight-picker" value={weight} onChange={setWeight} max={99} suffix="kg"/>
          <button onClick={handleAdd} disabled={!sel} style={{...S.addBtn,opacity:sel?1:0.35}}>+</button>
        </div>
      </div>
      {exercises.length>0&&(<div style={{marginBottom:4}}>{exercises.map((ex,i)=>(<div key={ex.id} style={S.exItem}>
        <span style={S.roundNum}>{i+1}</span>
        <div style={{flex:1,minWidth:0}}>
          <span style={{fontSize:14,fontWeight:600,display:"block"}}>{ex.name}</span>
          <span style={{fontSize:12,color:"#737373"}}>{ex.reps}r{ex.weight?` ¬∑ ${ex.weight}kg`:""}{ex.weight?<span style={{color:"#555"}}> ¬∑ {ex.reps*ex.weight}kg vol</span>:null}</span>
        </div>
        <div style={{display:"flex",gap:4}}>
          <button onClick={()=>move(i,-1)} style={S.microBtn} disabled={i===0}>‚Üë</button>
          <button onClick={()=>move(i,1)} style={S.microBtn} disabled={i===exercises.length-1}>‚Üì</button>
          <button onClick={()=>setEditIdx(i)} style={S.microBtn}>‚úé</button>
          <button onClick={()=>remove(ex.id)} style={{...S.microBtn,color:"#ef4444"}}>‚úï</button>
        </div>
      </div>))}</div>)}
      {exercises.length>0&&<StatsBar exercises={exercises} sets={sets}/>}
      {exercises.length>0&&(<div style={{marginTop:16}}>
        <SetsSelector sets={sets} onChange={setSets}/>
        <button onClick={onStart} style={S.startBtn}>START ‚Äî {pl(exercises.length*sets,"round")}</button>
        <div style={S.saveLoadRow}>
          <button onClick={()=>setShowSave(true)} style={S.secBtn}>Save Workout</button>
          <button onClick={()=>setShowLoad(true)} style={S.secBtn}>Load Workout</button>
        </div>
      </div>)}
      {exercises.length===0&&<div style={{textAlign:"center",marginTop:24}}><button onClick={()=>setShowLoad(true)} style={S.secBtn}>Load Workout</button></div>}
      {/* Warmup disclaimer */}
      <p style={{textAlign:"center",color:"#333",fontSize:11,marginTop:28,letterSpacing:1}}>Don't forget to stretch and warm up before starting your workout.</p>

      {editIdx!==null&&exercises[editIdx]&&<EditExerciseModal exercise={exercises[editIdx]} onSave={u=>updateExercise(editIdx,u)} onCancel={()=>setEditIdx(null)}/>}
      {showSave&&<SaveModal onSave={n=>{saveWorkout(n,exercises.map(({name,reps,weight})=>({name,reps,weight})));setWorkoutName(n);setShowSave(false)}} onCancel={()=>setShowSave(false)}/>}
      {showLoad&&<LoadModal workouts={savedWorkouts} onLoad={w=>{setExercises(w.exercises.map((e,i)=>({...e,id:Date.now()+i})));setWorkoutName(w.name);setShowLoad(false)}} onDelete={deleteWorkout} onCancel={()=>setShowLoad(false)}/>}
      {showMenu&&<MenuOverlay onNavigate={k=>{setShowMenu(false);onNavigate(k)}} onClose={()=>setShowMenu(false)}/>}
    </div>
  );
}

/* ‚îÄ‚îÄ‚îÄ COUNTDOWN (with cancel) ‚îÄ‚îÄ‚îÄ */
function CountdownScreen({onComplete,onCancel,muted}){
  const[count,setCount]=useState(3);
  const startRef=useRef(Date.now());
  const acRef=useRef(null);
  const beeped=useRef(new Set());
  const cancelled=useRef(false);
  const beep=(f,d,vol)=>{if(muted&&muted.current)return;try{if(!acRef.current)acRef.current=new(window.AudioContext||window.webkitAudioContext)();const o=acRef.current.createOscillator(),g=acRef.current.createGain();o.connect(g);g.connect(acRef.current.destination);o.frequency.value=f;g.gain.value=vol;o.start();o.stop(acRef.current.currentTime+d/1000)}catch{}};
  useEffect(()=>{
    const iv=setInterval(()=>{
      if(cancelled.current)return;
      const elapsed=Math.floor((Date.now()-startRef.current)/1000);
      const remaining=3-elapsed;
      if(remaining<=0){clearInterval(iv);if(!beeped.current.has(0)){beeped.current.add(0);beep(1000,300,0.7)}onComplete();return}
      if(!beeped.current.has(remaining)){beeped.current.add(remaining);beep(600,150,0.5);vibrate(50)}
      setCount(remaining);
    },100);
    return()=>clearInterval(iv);
  },[onComplete]);
  return(<div style={{...S.timerWrap,justifyContent:"center"}}>
    <div style={{fontSize:120,fontWeight:800,color:"#eab308",fontVariantNumeric:"tabular-nums"}}>{count}</div>
    <div style={{fontSize:14,color:"#555",letterSpacing:4,marginTop:12,textTransform:"uppercase"}}>Get Ready</div>
    <button onClick={()=>{cancelled.current=true;onCancel()}} style={{marginTop:40,background:"none",border:"1px solid #555",borderRadius:10,color:"#a3a3a3",padding:"10px 32px",fontSize:13,cursor:"pointer",fontFamily:"inherit",letterSpacing:1}}>Cancel</button>
  </div>);
}

/* ‚îÄ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ‚îÄ */
function getRingColor(sec,dynamic){if(!dynamic)return sec<=10?"#ef4444":"#eab308";if(sec>=40)return"#22c55e";if(sec>=25)return"#eab308";if(sec>=10)return"#f97316";return"#ef4444"}

function Timer({exercises,sets,onFinish,muted,mutedState,toggleMute}){
  const totalRounds=exercises.length*sets;
  const[globalRound,setGlobalRound]=useState(0);
  const[sec,setSec]=useState(60);
  const[elapsed,setElapsed]=useState(0);
  const[paused,setPaused]=useState(false);
  const[done,setDone]=useState(false);
  const[stoppedEarly,setStoppedEarly]=useState(false);
  const[preview,setPreview]=useState(false);
  const[dynamicRing,setDynamicRing]=useState(true);
  const[confirmAction,setConfirmAction]=useState(null);

  const roundStart=useRef(Date.now());
  const elapsedBase=useRef(0);
  const elapsedStart=useRef(Date.now());
  const beeped=useRef(new Set());
  const acRef=useRef(null);
  const wakeLock=useRef(null);
  const pauseTimeRef=useRef(null);
  const doneRef=useRef(false);
  const stoppedEarlyRef=useRef(false);
  const globalRoundRef=useRef(0);
  const elapsedRef=useRef(0);

  // Double-tap detection
  const lastTap=useRef(0);
  const handleRingTap=()=>{
    const now=Date.now();
    if(now-lastTap.current<300){togglePauseAction();lastTap.current=0}
    else{lastTap.current=now}
  };

  const currentSet=Math.floor(globalRound/exercises.length)+1;
  const currentRoundInSet=(globalRound%exercises.length)+1;
  const currentExercise=exercises[globalRound%exercises.length];
  const nextGlobal=globalRound+1;
  const nextExercise=nextGlobal<totalRounds?exercises[nextGlobal%exercises.length]:null;

  const beep=useCallback((f=800,d=150,vol=0.3)=>{
    if(muted.current)return;
    try{if(!acRef.current)acRef.current=new(window.AudioContext||window.webkitAudioContext)();const o=acRef.current.createOscillator(),g=acRef.current.createGain();o.connect(g);g.connect(acRef.current.destination);o.frequency.value=f;g.gain.value=vol;o.start();o.stop(acRef.current.currentTime+d/1000)}catch{}
  },[]);

  // Wake lock
  useEffect(()=>{
    const req=async()=>{try{wakeLock.current=await navigator.wakeLock.request("screen")}catch{}};
    req();
    const onVis=()=>{if(document.visibilityState==="visible")req()};
    document.addEventListener("visibilitychange",onVis);
    return()=>{if(wakeLock.current)wakeLock.current.release().catch(()=>{});document.removeEventListener("visibilitychange",onVis)};
  },[]);

  // Wall-clock timer with robust beep detection
  useEffect(()=>{
    if(paused||doneRef.current)return;
    const iv=setInterval(()=>{
      const now=Date.now();
      const roundElapsed=Math.floor((now-roundStart.current)/1000);
      const remaining=Math.max(0,60-roundElapsed);
      setSec(remaining);
      const el=elapsedBase.current+Math.floor((now-elapsedStart.current)/1000);
      setElapsed(el);
      elapsedRef.current=el;

      // Fire ALL missed beeps in 3-2-1 range
      for(let s=3;s>=1;s--){
        if(remaining<=s&&!beeped.current.has(s)){
          beeped.current.add(s);
          if(s===1){beep(800,200,0.6);vibrate(200)}
          else{beep(600,150,0.5);vibrate(100)}
        }
      }
      // Round end
      if(remaining<=0&&!beeped.current.has(0)){
        beeped.current.add(0);
        beep(1000,300,0.7);vibrate(300);
        const nextRound=globalRoundRef.current+1;
        if(nextRound>=totalRounds){
          doneRef.current=true;
          setDone(true);
        }else{
          globalRoundRef.current=nextRound;
          setGlobalRound(nextRound);
          roundStart.current=Date.now();
          beeped.current.clear();
        }
      }
    },150);
    return()=>clearInterval(iv);
  },[paused,totalRounds,beep]);

  const togglePauseAction=()=>{
    if(paused){
      const pausedDuration=Date.now()-pauseTimeRef.current;
      roundStart.current+=pausedDuration;
      elapsedStart.current+=pausedDuration;
      setPaused(false);
    }else{
      pauseTimeRef.current=Date.now();
      setPaused(true);
    }
  };

  const goNext=()=>{
    const next=globalRoundRef.current+1;
    if(next>=totalRounds){doneRef.current=true;setDone(true);return}
    globalRoundRef.current=next;setGlobalRound(next);roundStart.current=Date.now();beeped.current.clear();setSec(60);
  };
  const goPrev=()=>{
    if(globalRoundRef.current<=0)return;
    globalRoundRef.current-=1;setGlobalRound(globalRoundRef.current);roundStart.current=Date.now();beeped.current.clear();setSec(60);
  };

  const triggerStop=(type)=>{
    if(!paused){pauseTimeRef.current=Date.now();setPaused(true)}
    setConfirmAction(type);
  };
  const cancelConfirm=()=>{
    setConfirmAction(null);
    if(pauseTimeRef.current){const d=Date.now()-pauseTimeRef.current;roundStart.current+=d;elapsedStart.current+=d}
    setPaused(false);
  };
  const confirmStop=()=>{
    setConfirmAction(null);
    stoppedEarlyRef.current=true;
    setStoppedEarly(true);
    doneRef.current=true;
    setDone(true);
  };

  const totalVol=exercises.reduce((s,e)=>s+e.reps*(e.weight||0),0)*sets;
  const getVolumeForRounds=n=>{let v=0;for(let i=0;i<n;i++){const ex=exercises[i%exercises.length];v+=ex.reps*(ex.weight||0)}return v};

  // Fire completion callback
  useEffect(()=>{if(done){
    const completed=stoppedEarlyRef.current?globalRoundRef.current:totalRounds;
    const vol=stoppedEarlyRef.current?getVolumeForRounds(globalRoundRef.current):totalVol;
    onFinish({completedRounds:completed,totalRounds,elapsed:elapsedRef.current,totalVolume:vol,partial:stoppedEarlyRef.current});
  }},[done]);

  const prog=sec/60;const ringColor=getRingColor(sec,dynamicRing);

  return(
    <div style={S.timerWrap}>
      {/* Safe area + top bar - centered */}
      <div style={{width:"100%",maxWidth:500,margin:"0 auto",paddingTop:"max(12px, env(safe-area-inset-top, 12px))"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4,padding:"0 4px"}}>
          <div>
            <span style={S.roundLbl}>Round {currentRoundInSet}/{exercises.length}</span>
            {sets>1&&<span style={{...S.roundLbl,marginLeft:10,color:"#eab308"}}>Set {currentSet}/{sets}</span>}
          </div>
          <div style={{display:"flex",gap:6}}>
            <button onClick={()=>setDynamicRing(!dynamicRing)} style={{...S.prevToggle,fontSize:11,padding:"4px 8px",color:dynamicRing?"#eab308":"#555"}}>{dynamicRing?"‚óâ":"‚óã"}</button>
            <button onClick={toggleMute} style={{...S.prevToggle,fontSize:13,padding:"4px 8px",color:mutedState?"#ef4444":"#a3a3a3"}}>{mutedState?"üîá":"üîä"}</button>
            <button onClick={()=>setPreview(!preview)} style={S.prevToggle}>{preview?"Hide":"Preview"}</button>
            <button onClick={()=>triggerStop("home")} style={{...S.prevToggle,fontSize:13}}>‚åÇ</button>
          </div>
        </div>
      </div>

      {confirmAction==="stop"&&<ConfirmModal title="Stop Workout?" message="Your progress will be saved and the workout will end." onConfirm={confirmStop} onCancel={cancelConfirm}/>}
      {confirmAction==="home"&&<ConfirmModal title="Return Home?" message="This will end your workout and return to the home screen." onConfirm={confirmStop} onCancel={cancelConfirm}/>}

      {preview&&(<div style={S.overlay}><div style={S.modal}>
        <h3 style={S.modalTitle}>Workout Plan{sets>1?` ¬∑ ${pl(sets,"Set")}`:""}</h3>
        {exercises.map((x,i)=>{const isActive=i===globalRound%exercises.length;const isPast=i<globalRound%exercises.length;return(
          <div key={i} style={{display:"flex",alignItems:"center",gap:10,padding:"10px 8px",borderRadius:6,opacity:isPast?0.35:1,background:isActive?"rgba(234,179,8,0.1)":"transparent",borderLeft:isActive?"3px solid #eab308":"3px solid transparent"}}>
            <span style={{fontSize:12,color:"#737373",width:20,textAlign:"center"}}>{i+1}</span>
            <span style={{flex:1,fontSize:14,fontWeight:600}}>{x.name}</span>
            <span style={{fontSize:12,color:"#a3a3a3"}}>{x.reps}r{x.weight?` ¬∑ ${x.weight}kg`:""}</span>
          </div>)})}
        <button onClick={()=>setPreview(false)} style={S.modalBtn}>Close</button>
      </div></div>)}

      {/* Core center block */}
      <div style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",width:"100%",maxWidth:320,margin:"0 auto"}}>
        <div style={{textAlign:"center",marginBottom:4}}>
          <span style={{display:"block",fontSize:20,fontWeight:700,textTransform:"uppercase",letterSpacing:2}}>{currentExercise.name}</span>
          <span style={{display:"block",fontSize:20,color:"#eab308",marginTop:2,fontWeight:700}}>{currentExercise.reps} reps{currentExercise.weight?` ¬∑ ${currentExercise.weight}kg`:""}</span>
        </div>

        {/* Timer ring - double tap to pause */}
        <div onClick={handleRingTap} style={{position:"relative",width:"100%",aspectRatio:"1",cursor:"pointer"}}>
          <svg viewBox="0 0 200 200" style={{width:"100%",height:"100%"}}>
            <circle cx="100" cy="100" r="90" fill="none" stroke="rgba(255,255,255,0.06)" strokeWidth="6"/>
            <circle cx="100" cy="100" r="90" fill="none" stroke={ringColor} strokeWidth="6" strokeLinecap="round" strokeDasharray={2*Math.PI*90} strokeDashoffset={2*Math.PI*90*(1-prog)} transform="rotate(-90 100 100)" style={{transition:"stroke-dashoffset 0.3s linear,stroke 0.5s ease"}}/>
          </svg>
          <div style={{position:"absolute",inset:0,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"}}>
            <span style={{fontSize:60,fontWeight:800,fontVariantNumeric:"tabular-nums",letterSpacing:4,color:sec<=10?"#ef4444":"#fafafa"}}>{fmt(sec)}</span>
            <span style={{fontSize:14,color:"#737373",fontStyle:"italic",letterSpacing:3,marginTop:4,visibility:paused&&!confirmAction?"visible":"hidden"}}>PAUSED</span>
          </div>
        </div>

        {/* Up next - directly below ring */}
        <div style={{width:"100%",marginTop:6}}>
          {nextExercise?(<div style={S.upNext}>
            <span style={S.upNextLbl}>Up next</span>
            <span style={S.upNextTxt}>{nextExercise.name} ‚Äî {nextExercise.reps}r{nextExercise.weight?` ¬∑ ${nextExercise.weight}kg`:""}</span>
          </div>):(<div style={S.upNext}>
            <span style={S.upNextLbl}>Last round</span><span style={S.upNextTxt}>Finish strong üí™</span>
          </div>)}
        </div>
      </div>

      {/* Controls - tight below center block */}
      <div style={{width:"100%",maxWidth:500,margin:"0 auto",paddingBottom:12}}>
        <div style={{display:"flex",gap:10,justifyContent:"center",alignItems:"center",marginBottom:12}}>
          <button onClick={goPrev} disabled={globalRound<=0} style={{...S.skipBtn,opacity:globalRound<=0?0.25:1}}>‚ü®</button>
          <button onClick={togglePauseAction} style={S.ctrlBtn}>{paused?"‚ñ∂ Resume":"‚ùö‚ùö Pause"}</button>
          <button onClick={()=>triggerStop("stop")} style={S.stopBtn}>‚ñ† Stop</button>
          <button onClick={goNext} style={S.skipBtn}>‚ü©</button>
        </div>
        <div style={{display:"flex",gap:16,justifyContent:"center",fontSize:11,color:"#4a4a4a",fontVariantNumeric:"tabular-nums"}}>
          <span>{fmtElapsed(elapsed)} elapsed</span><span>¬∑</span><span>{totalVol.toLocaleString()}kg vol</span>
        </div>
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ‚îÄ COMPLETION SCREEN ‚îÄ‚îÄ‚îÄ */
function CompletionScreen({data,exercises,sets,workoutName,onHome}){
  const[copied,setCopied]=useState(false);
  const d=new Date();
  const generateSummary=()=>{
    const name=workoutName||`${timeOfDay(d)} Workout`;
    let txt=data.partial?"‚èπ CS Kettlebell EMOM (Partial)\n":"üèÅ CS Kettlebell EMOM\n";
    txt+=`${fmtDate(d)} ¬∑ ${pl(data.completedRounds,"round")}${data.partial?` of ${data.totalRounds}`:""}\n`;
    txt+="‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    exercises.forEach((ex,i)=>{txt+=`${i+1}. ${ex.name} ‚Äî ${ex.reps}r ¬∑ ${ex.weight}kg\n`});
    if(sets>1)txt+=`√ó${sets} sets\n`;
    txt+="‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    txt+=`Volume: ${data.totalVolume.toLocaleString()}kg ¬∑ Time: ${fmtElapsed(data.elapsed)}`;
    return txt;
  };
  const handleCopy=async()=>{
    try{await navigator.clipboard.writeText(generateSummary());setCopied(true);setTimeout(()=>setCopied(false),2000)}
    catch{/* fallback: select text */try{const ta=document.createElement("textarea");ta.value=generateSummary();document.body.appendChild(ta);ta.select();document.execCommand("copy");document.body.removeChild(ta);setCopied(true);setTimeout(()=>setCopied(false),2000)}catch{}}
  };
  return(<div style={S.timerWrap}>
    <div style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",textAlign:"center",padding:20}}>
      <div style={{fontSize:48,marginBottom:12}}>{data.partial?"‚èπ":"üèÅ"}</div>
      <h2 style={{fontSize:22,fontWeight:800,letterSpacing:3,margin:"0 0 4px"}}>{data.partial?"Workout Stopped":"Workout Complete"}</h2>
      {data.partial&&<span style={{fontSize:11,color:"#ef4444",fontWeight:700,background:"rgba(239,68,68,0.15)",padding:"3px 10px",borderRadius:4,marginBottom:8,display:"inline-block"}}>Partial</span>}
      <div style={{color:"#a3a3a3",fontSize:14,lineHeight:1.8,marginBottom:16}}>
        <div>{pl(data.completedRounds,"round")} of {data.totalRounds} completed</div>
        <div>{data.totalVolume.toLocaleString()}kg volume</div>
        <div style={{color:"#555",marginTop:4}}>Elapsed: {fmtElapsed(data.elapsed)}</div>
      </div>
      <div style={{background:"#141414",borderRadius:10,padding:16,width:"100%",maxWidth:360,marginBottom:20}}>
        <div style={{fontSize:10,letterSpacing:3,color:"#555",textTransform:"uppercase",marginBottom:10,textAlign:"center"}}>Workout Summary</div>
        {exercises.map((ex,i)=>(<div key={i} style={{display:"flex",justifyContent:"space-between",padding:"6px 0",borderBottom:i<exercises.length-1?"1px solid #1f1f1f":"none"}}>
          <span style={{fontSize:13,color:"#d4d4d4"}}>{i+1}. {ex.name}</span>
          <span style={{fontSize:12,color:"#737373"}}>{ex.reps}r ¬∑ {ex.weight}kg</span>
        </div>))}
        {sets>1&&<div style={{textAlign:"right",fontSize:12,color:"#eab308",marginTop:8}}>√ó{sets} sets</div>}
      </div>
      <div style={{display:"flex",gap:8,width:"100%",maxWidth:360}}>
        <button onClick={handleCopy} style={{...S.secBtn,flex:"none",padding:"12px 20px",fontSize:12}}>{copied?"‚úì Copied":"üìã Copy"}</button>
        <button onClick={onHome} style={{...S.startBtn,flex:1}}>Return to Home</button>
      </div>
    </div>
  </div>);
}

/* ‚îÄ‚îÄ‚îÄ APP ‚îÄ‚îÄ‚îÄ */
function EmomApp(){
  const[screen,setScreen]=useState("home");
  const[exercises,setExercises]=useState([]);
  const[sets,setSets]=useState(1);
  const[workoutName,setWorkoutName]=useState(null);
  const[completionData,setCompletionData]=useState(null);
  const mutedRef=useRef(store.get(STORE_MUTE)||false);
  const[mutedState,setMutedState]=useState(mutedRef.current);
  const startTimeRef=useRef(null);

  const{library,addExercise}=useExerciseLibrary();
  const{workouts,saveWorkout,deleteWorkout}=useSavedWorkouts();
  const{logs,addLog,deleteLog,resetAll}=useLogs();
  const{favs,toggle:toggleFav}=useFavorites();

  const toggleMute=()=>{mutedRef.current=!mutedRef.current;setMutedState(mutedRef.current);store.set(STORE_MUTE,mutedRef.current)};

  const handleStart=()=>{startTimeRef.current=new Date();setScreen("countdown")};
  const handleCountdownDone=useCallback(()=>setScreen("timer"),[]);
  const handleCountdownCancel=useCallback(()=>setScreen("home"),[]);
  const handleFinish=useCallback(data=>{
    addLog({
      id:Date.now(),
      startTime:startTimeRef.current.toISOString(),
      workoutName,
      exercises:exercises.map(({name,reps,weight})=>({name,reps,weight})),
      sets,
      completedRounds:data.completedRounds,
      totalRounds:data.totalRounds,
      elapsed:data.elapsed,
      totalVolume:data.totalVolume,
      partial:data.partial
    });
    setCompletionData(data);
    setScreen("complete");
  },[exercises,sets,workoutName,addLog]);

  const goHome=()=>setScreen("home");

  if(screen==="countdown")return<CountdownScreen onComplete={handleCountdownDone} onCancel={handleCountdownCancel} muted={mutedRef}/>;
  if(screen==="timer")return<Timer exercises={exercises} sets={sets} onFinish={handleFinish} muted={mutedRef} mutedState={mutedState} toggleMute={toggleMute}/>;
  if(screen==="complete")return<CompletionScreen data={completionData} exercises={exercises} sets={sets} workoutName={workoutName} onHome={goHome}/>;
  if(screen==="logs")return<LogsScreen logs={logs} deleteLog={deleteLog} onBack={goHome}/>;
  if(screen==="stats")return<StatsScreen logs={logs} resetAll={resetAll} onBack={goHome}/>;
  if(screen==="readme")return<ReadMeScreen onBack={goHome}/>;
  if(screen==="about")return<AboutScreen onBack={goHome}/>;
  return<WorkoutBuilder exercises={exercises} setExercises={setExercises} sets={sets} setSets={setSets} onStart={handleStart} library={library} addExercise={addExercise} savedWorkouts={workouts} saveWorkout={saveWorkout} deleteWorkout={deleteWorkout} workoutName={workoutName} setWorkoutName={setWorkoutName} onNavigate={setScreen} favs={favs} toggleFav={toggleFav}/>;
}

/* ‚îÄ‚îÄ‚îÄ STYLES ‚îÄ‚îÄ‚îÄ */
const S={
  builder:{minHeight:"100vh",background:"#0a0a0a",color:"#fafafa",padding:"0 16px 48px",fontFamily:"inherit",maxWidth:520,margin:"0 auto"},
  logoArea:{textAlign:"center",marginBottom:20},
  titleMain:{fontSize:16,fontWeight:600,letterSpacing:4,margin:0,color:"#a3a3a3",textTransform:"uppercase"},
  titleSub:{fontSize:32,fontWeight:800,letterSpacing:6,margin:"4px 0 0",color:"#eab308"},
  input:{background:"#171717",border:"1px solid #262626",borderRadius:8,color:"#fafafa",padding:"10px 12px",fontSize:14,fontFamily:"inherit",outline:"none",width:"100%",boxSizing:"border-box"},
  editLabel:{display:"block",fontSize:10,color:"#555",letterSpacing:2,textTransform:"uppercase",marginBottom:6,textAlign:"center"},
  addBtn:{background:"#eab308",color:"#0a0a0a",border:"none",borderRadius:12,width:52,height:52,fontSize:26,fontWeight:700,cursor:"pointer",flexShrink:0,alignSelf:"center"},
  dropdown:{position:"absolute",top:"100%",left:0,right:0,background:"#1c1c1c",border:"1px solid #333",borderRadius:8,marginTop:4,zIndex:50,overflow:"hidden"},
  ddItem:{padding:"11px 14px",fontSize:14,cursor:"pointer",borderBottom:"1px solid #1f1f1f"},
  exItem:{display:"flex",alignItems:"center",gap:10,padding:"11px 0",borderBottom:"1px solid #1a1a1a"},
  roundNum:{width:26,height:26,borderRadius:"50%",background:"#262626",display:"flex",alignItems:"center",justifyContent:"center",fontSize:11,fontWeight:700,color:"#a3a3a3",flexShrink:0},
  microBtn:{background:"none",border:"1px solid #333",borderRadius:4,color:"#737373",width:26,height:26,fontSize:12,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",padding:0},
  statsBar:{background:"#111",borderRadius:10,padding:"14px 20px",marginTop:12},
  statBlock:{display:"inline-flex",alignItems:"baseline",gap:6},
  statValue:{fontSize:22,fontWeight:800,color:"#fafafa"},
  statLabel:{fontSize:11,color:"#555",letterSpacing:1},
  setsBtn:{width:40,height:40,borderRadius:"50%",background:"#171717",border:"1px solid #333",color:"#fafafa",fontSize:22,fontWeight:600,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",padding:0},
  startBtn:{width:"100%",padding:"14px",background:"#eab308",color:"#0a0a0a",border:"none",borderRadius:10,fontSize:15,fontWeight:800,fontFamily:"inherit",letterSpacing:2,cursor:"pointer"},
  saveLoadRow:{display:"flex",gap:8,marginTop:10},
  secBtn:{flex:1,padding:"11px 16px",background:"transparent",border:"1px solid #333",borderRadius:10,color:"#a3a3a3",fontSize:13,fontWeight:600,cursor:"pointer",letterSpacing:1,fontFamily:"inherit"},
  overlay:{position:"fixed",inset:0,background:"rgba(0,0,0,0.85)",zIndex:100,display:"flex",alignItems:"center",justifyContent:"center",padding:20},
  modal:{background:"#171717",borderRadius:14,padding:24,width:"100%",maxWidth:380,maxHeight:"80vh",overflowY:"auto"},
  modalTitle:{fontSize:16,fontWeight:700,letterSpacing:2,textAlign:"center",margin:"0 0 16px"},
  modalBtn:{width:"100%",marginTop:16,padding:"10px",background:"#262626",color:"#fafafa",border:"none",borderRadius:8,fontSize:13,cursor:"pointer",fontFamily:"inherit"},
  loadItem:{display:"flex",alignItems:"center",gap:8,padding:"12px 8px",borderBottom:"1px solid #222",cursor:"pointer"},
  menuItem:{width:"100%",display:"flex",alignItems:"center",gap:14,padding:"14px 16px",background:"#1a1a1a",border:"none",borderRadius:8,color:"#d4d4d4",fontSize:14,fontWeight:600,cursor:"pointer",marginBottom:8,letterSpacing:1},
  timerWrap:{minHeight:"100vh",background:"#0a0a0a",color:"#fafafa",fontFamily:"'JetBrains Mono','SF Mono','Fira Code','Courier New',monospace",display:"flex",flexDirection:"column",alignItems:"center",padding:"0 20px 20px",position:"relative"},
  roundLbl:{fontSize:13,color:"#a3a3a3",letterSpacing:1},
  prevToggle:{background:"none",border:"1px solid #333",borderRadius:6,color:"#a3a3a3",fontSize:12,padding:"5px 12px",cursor:"pointer",fontFamily:"inherit"},
  ctrlBtn:{background:"#262626",color:"#fafafa",border:"none",borderRadius:10,padding:"12px 24px",fontSize:14,fontWeight:600,cursor:"pointer",fontFamily:"inherit"},
  stopBtn:{background:"transparent",color:"#ef4444",border:"1px solid #ef4444",borderRadius:10,padding:"12px 24px",fontSize:14,fontWeight:600,cursor:"pointer",fontFamily:"inherit"},
  skipBtn:{background:"none",border:"1px solid #333",borderRadius:10,color:"#a3a3a3",width:40,height:44,fontSize:18,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",padding:0,fontFamily:"inherit"},
  upNext:{background:"#141414",borderRadius:10,padding:"12px 20px",width:"100%",textAlign:"center"},
  upNextLbl:{display:"block",fontSize:10,letterSpacing:3,color:"#737373",textTransform:"uppercase",marginBottom:3},
  upNextTxt:{fontSize:14,color:"#d4d4d4"},
  page:{minHeight:"100vh",background:"#0a0a0a",color:"#fafafa",padding:"0 16px 48px",fontFamily:"'JetBrains Mono','SF Mono','Fira Code','Courier New',monospace",maxWidth:520,margin:"0 auto"},
  sortBtn:{flex:1,padding:"10px",border:"none",borderRadius:8,fontSize:12,fontWeight:700,cursor:"pointer",letterSpacing:1,fontFamily:"inherit"},
};

ReactDOM.createRoot(document.getElementById("root")).render(<EmomApp/>);
</script>
</body>
</html>
