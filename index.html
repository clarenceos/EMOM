<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0a0a">
<title>CS Kettlebell EMOM Timer</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚è±</text></svg>">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #0a0a0a; font-family: 'JetBrains Mono','SF Mono','Fira Code','Courier New',monospace; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
  ::-webkit-scrollbar { display: none; }
  input:focus, button:focus { outline: none; }
</style>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

const STORAGE_EXERCISES = "emom-exercises";
const STORAGE_WORKOUTS = "emom-saved-workouts";
const DEFAULT_REPS = 10;
const DEFAULT_WEIGHT = 12;

const DEFAULT_EXERCISES = [
  "Two-hand swing","One-hand swing","Deadlift","Clean","Goblet squat",
  "Double kettlebell front squat","Split squat","Bulgarian split squat",
  "Strict overhead press","Push press","Floor press","Farmer carry",
  "Suitcase carry","Rack carry","Overhead carry","Snatch","High pull",
  "Clean and press","Thruster","Bent-over row","Renegade row","Gorilla row",
  "Turkish get-up","Windmill","Russian twist","Halo","Lunges",
  "Reverse lunges","Alternating swing","Complex combinations",
];

const pl = (n, word) => `${n} ${word}${n === 1 ? "" : "s"}`;

// localStorage helpers (replaces window.storage)
const store = {
  get: (key) => { try { return JSON.parse(localStorage.getItem(key)); } catch { return null; } },
  set: (key, val) => { try { localStorage.setItem(key, JSON.stringify(val)); } catch {} },
};

function useExerciseLibrary() {
  const [library, setLibrary] = useState(() => {
    const custom = store.get(STORAGE_EXERCISES);
    if (custom && Array.isArray(custom)) {
      const m = [...DEFAULT_EXERCISES];
      custom.forEach(c => { if (!m.some(x => x.toLowerCase() === c.toLowerCase())) m.push(c); });
      return m;
    }
    return DEFAULT_EXERCISES;
  });
  const addExercise = useCallback((name) => {
    const t = name.trim(); if (!t) return;
    setLibrary(prev => {
      if (prev.some(e => e.toLowerCase() === t.toLowerCase())) return prev;
      const next = [...prev, t];
      const custom = next.filter(n => !DEFAULT_EXERCISES.some(d => d.toLowerCase() === n.toLowerCase()));
      store.set(STORAGE_EXERCISES, custom);
      return next;
    });
  }, []);
  return { library, addExercise };
}

function useSavedWorkouts() {
  const [workouts, setWorkouts] = useState(() => store.get(STORAGE_WORKOUTS) || []);
  const saveWorkout = useCallback((name, exercises) => {
    setWorkouts(prev => { const next = [...prev, { id: Date.now(), name, exercises }]; store.set(STORAGE_WORKOUTS, next); return next; });
  }, []);
  const deleteWorkout = useCallback((id) => {
    setWorkouts(prev => { const next = prev.filter(w => w.id !== id); store.set(STORAGE_WORKOUTS, next); return next; });
  }, []);
  return { workouts, saveWorkout, deleteWorkout };
}

function ConfirmModal({ title, message, onConfirm, onCancel }) {
  return (
    <div style={S.overlay}><div style={S.modal}>
      <h3 style={S.modalTitle}>{title}</h3>
      <p style={{ textAlign: "center", color: "#a3a3a3", fontSize: 14, margin: "0 0 20px" }}>{message}</p>
      <div style={{ display: "flex", gap: 8 }}>
        <button onClick={onCancel} style={{ ...S.modalBtn, flex: 1, marginTop: 0 }}>Cancel</button>
        <button onClick={onConfirm} style={{ ...S.modalBtn, flex: 1, marginTop: 0, background: "#ef4444", color: "#fff", fontWeight: 700 }}>Confirm</button>
      </div>
    </div></div>
  );
}

function NumInput({ value, onChange, max, label }) {
  const handleChange = (e) => {
    const raw = e.target.value.replace(/[^0-9]/g, "");
    if (raw === "") { onChange(0); return; }
    onChange(Math.min(parseInt(raw, 10), max));
  };
  return (
    <div style={{ flex: 1 }}>
      <label style={S.editLabel}>{label}</label>
      <input type="text" inputMode="numeric" pattern="[0-9]*" value={String(value)} onChange={handleChange} style={{ ...S.input, textAlign: "center", fontSize: 18, fontWeight: 700 }} />
    </div>
  );
}

function EditExerciseModal({ exercise, onSave, onCancel }) {
  const [reps, setReps] = useState(exercise.reps);
  const [weight, setWeight] = useState(exercise.weight);
  return (
    <div style={S.overlay}><div style={S.modal}>
      <h3 style={S.modalTitle}>Edit Exercise</h3>
      <p style={{ textAlign: "center", color: "#eab308", fontSize: 14, fontWeight: 600, margin: "0 0 16px" }}>{exercise.name}</p>
      <div style={{ display: "flex", gap: 12, marginBottom: 16 }}>
        <NumInput value={reps} onChange={setReps} max={99} label="Reps" />
        <NumInput value={weight} onChange={setWeight} max={99} label="Weight (kg)" />
      </div>
      <div style={{ display: "flex", gap: 8 }}>
        <button onClick={onCancel} style={{ ...S.modalBtn, flex: 1, marginTop: 0 }}>Cancel</button>
        <button onClick={() => onSave({ reps, weight })} style={{ ...S.modalBtn, flex: 1, marginTop: 0, background: "#eab308", color: "#0a0a0a", fontWeight: 700 }}>Save</button>
      </div>
    </div></div>
  );
}

function ScrollPicker({ value, onChange, max = 20, label, unit }) {
  const ref = useRef(null);
  const H = 36;
  useEffect(() => {
    const el = ref.current; if (!el) return;
    el.scrollTop = value * H;
    const t1 = setTimeout(() => { el.scrollTop = value * H; }, 50);
    const t2 = setTimeout(() => { el.scrollTop = value * H; }, 150);
    return () => { clearTimeout(t1); clearTimeout(t2); };
  }, []);
  useEffect(() => { if (ref.current) { const cur = Math.round(ref.current.scrollTop / H); if (cur !== value) ref.current.scrollTo({ top: value * H, behavior: "smooth" }); } }, [value]);
  const handleScroll = () => { if (!ref.current) return; const idx = Math.round(ref.current.scrollTop / H); const c = Math.max(0, Math.min(max, idx)); if (c !== value) onChange(c); };
  const snap = (i) => ref.current?.scrollTo({ top: i * H, behavior: "smooth" });
  return (
    <div style={{ position: "relative", width: 64, height: 148, flexShrink: 0 }}>
      <div style={{ position: "absolute", top: -16, left: 0, right: 0, textAlign: "center", fontSize: 9, color: "#555", letterSpacing: 2, textTransform: "uppercase" }}>{label}</div>
      <div style={{ position: "absolute", top: "50%", left: 2, right: 2, height: 38, transform: "translateY(-50%)", border: "2px solid #eab308", borderRadius: 8, pointerEvents: "none", zIndex: 1 }} />
      <div style={{ position: "absolute", top: 0, left: 0, right: 0, height: 50, background: "linear-gradient(to bottom, #0a0a0a, transparent)", pointerEvents: "none", zIndex: 1 }} />
      <div style={{ position: "absolute", bottom: 0, left: 0, right: 0, height: 50, background: "linear-gradient(to top, #0a0a0a, transparent)", pointerEvents: "none", zIndex: 1 }} />
      <div ref={ref} onScroll={handleScroll} style={{ height: "100%", overflowY: "scroll", scrollSnapType: "y mandatory", WebkitOverflowScrolling: "touch", scrollbarWidth: "none", msOverflowStyle: "none" }}>
        <div style={{ height: H * 2 }} />
        {Array.from({ length: max + 1 }, (_, i) => (
          <div key={i} onClick={() => snap(i)} style={{ height: H, display: "flex", alignItems: "center", justifyContent: "center", scrollSnapAlign: "center", cursor: "pointer", userSelect: "none", color: i === value ? "#eab308" : "#555", fontWeight: i === value ? 800 : 400, fontSize: i === value ? 22 : 15, transition: "all 0.12s", fontFamily: "inherit" }}>
            {i}{i === value && unit ? <span style={{ fontSize: 11, marginLeft: 2, color: "#777" }}>{unit}</span> : null}
          </div>
        ))}
        <div style={{ height: H * 2 }} />
      </div>
    </div>
  );
}

function ExerciseDropdown({ value, onChange, library, onCustomAdd }) {
  const [open, setOpen] = useState(false);
  const [filter, setFilter] = useState("");
  const ref = useRef(null);
  useEffect(() => { const h = e => { if (ref.current && !ref.current.contains(e.target)) setOpen(false); }; document.addEventListener("mousedown", h); return () => document.removeEventListener("mousedown", h); }, []);
  const filtered = library.filter(e => e.toLowerCase().includes(filter.toLowerCase()));
  return (
    <div ref={ref} style={{ position: "relative", flex: 1, minWidth: 0 }}>
      <button onClick={() => setOpen(!open)} style={{ ...S.input, cursor: "pointer", textAlign: "left", display: "flex", justifyContent: "space-between", alignItems: "center", color: value ? "#fafafa" : "#666", height: 44 }}>
        <span style={{ overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{value || "Select exercise"}</span>
        <span style={{ fontSize: 10, color: "#555", marginLeft: 8, flexShrink: 0 }}>{open ? "‚ñ≤" : "‚ñº"}</span>
      </button>
      {open && (
        <div style={S.dropdown}>
          <input type="text" value={filter} placeholder="Search or type new‚Ä¶" onChange={e => setFilter(e.target.value)} autoFocus style={{ ...S.input, borderRadius: 0, borderBottom: "1px solid #333", position: "sticky", top: 0, zIndex: 2, background: "#1c1c1c" }} />
          <div style={{ maxHeight: 200, overflowY: "auto" }}>
            {filtered.map(ex => (
              <div key={ex} style={{ ...S.ddItem, background: ex === value ? "rgba(234,179,8,0.1)" : "transparent" }} onMouseDown={() => { onChange(ex); setFilter(""); setOpen(false); }}>{ex}</div>
            ))}
            {filter.trim() && !library.some(e => e.toLowerCase() === filter.trim().toLowerCase()) && (
              <div style={{ ...S.ddItem, color: "#eab308", fontStyle: "italic" }} onMouseDown={() => { onCustomAdd(filter.trim()); onChange(filter.trim()); setFilter(""); setOpen(false); }}>+ Add "{filter.trim()}"</div>
            )}
          </div>
        </div>
      )}
    </div>
  );
}

function IntensityMeter({ volume }) {
  let pct, color, label;
  if (volume <= 0) { pct = 0; color = "#333"; label = "‚Äî"; }
  else if (volume < 1000) { pct = volume / 2000 * 40; color = "#22c55e"; label = "Light"; }
  else if (volume < 2000) { pct = 20 + (volume - 1000) / 1000 * 20; color = "#22c55e"; label = "Light"; }
  else if (volume < 2750) { pct = 40 + (volume - 2000) / 750 * 20; color = "#eab308"; label = "Moderate"; }
  else if (volume < 3500) { pct = 60 + (volume - 2750) / 750 * 20; color = "#f97316"; label = "Hard"; }
  else { pct = Math.min(100, 80 + (volume - 3500) / 1500 * 20); color = "#ef4444"; label = "Intense"; }
  return (
    <div style={{ marginTop: 8 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 6 }}>
        <span style={{ fontSize: 10, letterSpacing: 2, color: "#555", textTransform: "uppercase" }}>Intensity</span>
        <span style={{ fontSize: 12, fontWeight: 700, color }}>{label}</span>
      </div>
      <div style={{ height: 6, borderRadius: 3, background: "#1a1a1a", overflow: "hidden" }}>
        <div style={{ height: "100%", borderRadius: 3, width: `${pct}%`, background: `linear-gradient(90deg, #22c55e, ${color})`, transition: "width 0.4s, background 0.4s" }} />
      </div>
    </div>
  );
}

function StatsBar({ exercises, sets }) {
  const totalTime = exercises.length * sets;
  const totalVolume = exercises.reduce((sum, ex) => sum + ex.reps * (ex.weight || 0), 0) * sets;
  return (
    <div style={S.statsBar}>
      <div style={{ display: "flex", justifyContent: "center", gap: 20, alignItems: "baseline" }}>
        <div style={S.statBlock}><span style={S.statValue}>{totalTime}</span><span style={S.statLabel}>min</span></div>
        <div style={{ width: 1, height: 24, background: "#262626" }} />
        <div style={S.statBlock}><span style={S.statValue}>{totalVolume.toLocaleString()}</span><span style={S.statLabel}>kg vol</span></div>
      </div>
      <IntensityMeter volume={totalVolume} />
    </div>
  );
}

function SetsSelector({ sets, onChange }) {
  return (
    <div style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 16, marginBottom: 12 }}>
      <button onClick={() => onChange(Math.max(1, sets - 1))} style={S.setsBtn}>‚àí</button>
      <div style={{ textAlign: "center", minWidth: 60 }}>
        <span style={{ fontSize: 24, fontWeight: 800, color: "#fafafa" }}>{sets}</span>
        <span style={{ fontSize: 11, color: "#555", letterSpacing: 2, display: "block", marginTop: 2 }}>{sets === 1 ? "SET" : "SETS"}</span>
      </div>
      <button onClick={() => onChange(Math.min(10, sets + 1))} style={S.setsBtn}>+</button>
    </div>
  );
}

function SaveModal({ onSave, onCancel }) {
  const [name, setName] = useState("");
  return (
    <div style={S.overlay}><div style={S.modal}>
      <h3 style={S.modalTitle}>Save Workout</h3>
      <input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="Workout name" autoFocus style={{ ...S.input, marginBottom: 16, width: "100%", boxSizing: "border-box" }} />
      <div style={{ display: "flex", gap: 8 }}>
        <button onClick={onCancel} style={{ ...S.modalBtn, flex: 1, marginTop: 0 }}>Cancel</button>
        <button onClick={() => name.trim() && onSave(name.trim())} disabled={!name.trim()} style={{ ...S.modalBtn, flex: 1, marginTop: 0, background: name.trim() ? "#eab308" : "#333", color: name.trim() ? "#0a0a0a" : "#666", fontWeight: 700 }}>Save</button>
      </div>
    </div></div>
  );
}

function LoadModal({ workouts, onLoad, onDelete, onCancel }) {
  return (
    <div style={S.overlay}><div style={S.modal}>
      <h3 style={S.modalTitle}>Load Workout</h3>
      {workouts.length === 0 && <p style={{ textAlign: "center", color: "#666", fontSize: 14 }}>No saved workouts yet</p>}
      {workouts.map(w => (
        <div key={w.id} style={S.loadItem}>
          <div style={{ flex: 1, cursor: "pointer" }} onClick={() => onLoad(w)}>
            <span style={{ display: "block", fontSize: 14, fontWeight: 600 }}>{w.name}</span>
            <span style={{ display: "block", fontSize: 12, color: "#737373", marginTop: 2 }}>{pl(w.exercises.length, "round")}</span>
          </div>
          <button onClick={() => onDelete(w.id)} style={{ ...S.microBtn, color: "#ef4444" }}>‚úï</button>
        </div>
      ))}
      <button onClick={onCancel} style={S.modalBtn}>Close</button>
    </div></div>
  );
}

function WorkoutBuilder({ exercises, setExercises, sets, setSets, onStart, library, addExercise, savedWorkouts, saveWorkout, deleteWorkout }) {
  const [sel, setSel] = useState("");
  const [reps, setReps] = useState(DEFAULT_REPS);
  const [weight, setWeight] = useState(DEFAULT_WEIGHT);
  const [showSave, setShowSave] = useState(false);
  const [showLoad, setShowLoad] = useState(false);
  const [editIdx, setEditIdx] = useState(null);

  const handleAdd = () => { if (!sel) return; setExercises(prev => [...prev, { id: Date.now(), name: sel, reps, weight }]); setSel(""); };
  const remove = id => setExercises(prev => prev.filter(e => e.id !== id));
  const move = (i, d) => setExercises(prev => { const n = [...prev]; const j = i + d; if (j < 0 || j >= n.length) return prev; [n[i], n[j]] = [n[j], n[i]]; return n; });
  const updateExercise = (idx, updates) => { setExercises(prev => prev.map((e, i) => i === idx ? { ...e, ...updates } : e)); setEditIdx(null); };

  return (
    <div style={S.builder}>
      <div style={S.logoArea}>
        <div style={{ fontSize: 36, marginBottom: 8 }}>‚è±</div>
        <h1 style={S.titleMain}>CS Kettlebell</h1>
        <h1 style={S.titleSub}>EMOM Timer</h1>
      </div>
      <div style={S.addRow}>
        <ExerciseDropdown value={sel} onChange={setSel} library={library} onCustomAdd={addExercise} />
        <div style={S.pickersRow}>
          <ScrollPicker key="reps-picker" value={reps} onChange={setReps} max={20} label="reps" />
          <ScrollPicker key="weight-picker" value={weight} onChange={setWeight} max={99} label="kg" unit="kg" />
          <button onClick={handleAdd} disabled={!sel} style={{ ...S.addBtn, opacity: sel ? 1 : 0.35 }}>+</button>
        </div>
      </div>
      {exercises.length > 0 && (
        <div style={{ marginBottom: 4 }}>
          {exercises.map((ex, i) => (
            <div key={ex.id} style={S.exItem}>
              <span style={S.roundNum}>{i + 1}</span>
              <div style={{ flex: 1, minWidth: 0 }}>
                <span style={{ fontSize: 14, fontWeight: 600, display: "block" }}>{ex.name}</span>
                <span style={{ fontSize: 12, color: "#737373" }}>
                  {ex.reps}r{ex.weight ? ` ¬∑ ${ex.weight}kg` : ""}
                  {ex.weight ? <span style={{ color: "#555" }}> ¬∑ {ex.reps * ex.weight}kg vol</span> : null}
                </span>
              </div>
              <div style={{ display: "flex", gap: 4 }}>
                <button onClick={() => move(i, -1)} style={S.microBtn} disabled={i === 0}>‚Üë</button>
                <button onClick={() => move(i, 1)} style={S.microBtn} disabled={i === exercises.length - 1}>‚Üì</button>
                <button onClick={() => setEditIdx(i)} style={S.microBtn}>‚úé</button>
                <button onClick={() => remove(ex.id)} style={{ ...S.microBtn, color: "#ef4444" }}>‚úï</button>
              </div>
            </div>
          ))}
        </div>
      )}
      {exercises.length > 0 && <StatsBar exercises={exercises} sets={sets} />}
      {exercises.length > 0 && (
        <div style={{ marginTop: 16 }}>
          <SetsSelector sets={sets} onChange={setSets} />
          <button onClick={onStart} style={S.startBtn}>START ‚Äî {pl(exercises.length * sets, "round")}</button>
          <div style={S.saveLoadRow}>
            <button onClick={() => setShowSave(true)} style={S.secBtn}>Save Workout</button>
            <button onClick={() => setShowLoad(true)} style={S.secBtn}>Load Workout</button>
          </div>
        </div>
      )}
      {exercises.length === 0 && <div style={{ textAlign: "center", marginTop: 24 }}><button onClick={() => setShowLoad(true)} style={S.secBtn}>Load Workout</button></div>}
      {editIdx !== null && exercises[editIdx] && <EditExerciseModal exercise={exercises[editIdx]} onSave={(u) => updateExercise(editIdx, u)} onCancel={() => setEditIdx(null)} />}
      {showSave && <SaveModal onSave={n => { saveWorkout(n, exercises.map(({ name, reps, weight }) => ({ name, reps, weight }))); setShowSave(false); }} onCancel={() => setShowSave(false)} />}
      {showLoad && <LoadModal workouts={savedWorkouts} onLoad={w => { setExercises(w.exercises.map((e, i) => ({ ...e, id: Date.now() + i }))); setShowLoad(false); }} onDelete={deleteWorkout} onCancel={() => setShowLoad(false)} />}
    </div>
  );
}

function getRingColor(sec, dynamic) {
  if (!dynamic) return sec <= 10 ? "#ef4444" : "#eab308";
  if (sec >= 40) return "#22c55e";
  if (sec >= 25) return "#eab308";
  if (sec >= 10) return "#f97316";
  return "#ef4444";
}

function fmt(s) { return `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, "0")}`; }
function fmtElapsed(s) {
  const h = Math.floor(s / 3600); const m = Math.floor((s % 3600) / 60); const sec = s % 60;
  if (h > 0) return `${h}:${m.toString().padStart(2,"0")}:${sec.toString().padStart(2,"0")}`;
  return `${m}:${sec.toString().padStart(2,"0")}`;
}

function Timer({ exercises, sets, onStop }) {
  const totalRounds = exercises.length * sets;
  const [globalRound, setGlobalRound] = useState(0);
  const [sec, setSec] = useState(60);
  const [elapsed, setElapsed] = useState(0);
  const [paused, setPaused] = useState(false);
  const [done, setDone] = useState(false);
  const [stoppedEarly, setStoppedEarly] = useState(false);
  const [preview, setPreview] = useState(false);
  const [dynamicRing, setDynamicRing] = useState(true);
  const [confirmAction, setConfirmAction] = useState(null);
  const iv = useRef(null);
  const elapsedIv = useRef(null);
  const ac = useRef(null);

  const currentSet = Math.floor(globalRound / exercises.length) + 1;
  const currentRoundInSet = (globalRound % exercises.length) + 1;
  const currentExercise = exercises[globalRound % exercises.length];
  const nextGlobal = globalRound + 1;
  const nextExercise = nextGlobal < totalRounds ? exercises[nextGlobal % exercises.length] : null;
  const completedRounds = globalRound;

  const beep = useCallback((f = 800, d = 150) => {
    try {
      if (!ac.current) ac.current = new (window.AudioContext || window.webkitAudioContext)();
      const o = ac.current.createOscillator(), g = ac.current.createGain();
      o.connect(g); g.connect(ac.current.destination);
      o.frequency.value = f; g.gain.value = 0.3; o.start(); o.stop(ac.current.currentTime + d / 1000);
    } catch {}
  }, []);

  useEffect(() => {
    if (paused || done) { clearInterval(iv.current); return; }
    iv.current = setInterval(() => {
      setSec(p => {
        if (p <= 4 && p > 1) beep(600, 100);
        if (p <= 1) { beep(1000, 250); setGlobalRound(r => { if (r + 1 >= totalRounds) { setDone(true); return r; } return r + 1; }); return 60; }
        return p - 1;
      });
    }, 1000);
    return () => clearInterval(iv.current);
  }, [paused, done, totalRounds, beep]);

  useEffect(() => {
    if (paused || done) { clearInterval(elapsedIv.current); return; }
    elapsedIv.current = setInterval(() => setElapsed(p => p + 1), 1000);
    return () => clearInterval(elapsedIv.current);
  }, [paused, done]);

  const goNext = () => { if (globalRound + 1 >= totalRounds) { setDone(true); return; } setGlobalRound(r => r + 1); setSec(60); };
  const goPrev = () => { if (globalRound <= 0) return; setGlobalRound(r => r - 1); setSec(60); };
  const handleStop = () => { setStoppedEarly(true); setDone(true); };
  const getVolumeForRounds = (numRounds) => { let vol = 0; for (let i = 0; i < numRounds; i++) { const ex = exercises[i % exercises.length]; vol += ex.reps * (ex.weight || 0); } return vol; };

  const totalVol = exercises.reduce((s, e) => s + e.reps * (e.weight || 0), 0) * sets;
  const prog = sec / 60;
  const ringColor = getRingColor(sec, dynamicRing);

  if (done) {
    const finishedRounds = stoppedEarly ? completedRounds : totalRounds;
    const finishedVol = stoppedEarly ? getVolumeForRounds(completedRounds) : totalVol;
    return (
      <div style={S.timer}>
        <div style={S.finArea}>
          <div style={{ fontSize: 48, marginBottom: 12 }}>{stoppedEarly ? "‚èπ" : "üèÅ"}</div>
          <h2 style={S.finTitle}>{stoppedEarly ? "Workout Stopped" : "Workout Complete"}</h2>
          <div style={{ color: "#a3a3a3", fontSize: 14, lineHeight: 1.8, marginBottom: 24 }}>
            <div>{pl(finishedRounds, "round")} of {totalRounds} completed</div>
            <div>{finishedVol.toLocaleString()}kg volume</div>
            <div style={{ color: "#555", marginTop: 4 }}>Elapsed: {fmtElapsed(elapsed)}</div>
          </div>
          <button onClick={onStop} style={S.startBtn}>Return to Home</button>
        </div>
      </div>
    );
  }

  return (
    <div style={S.timer}>
      <div style={S.topBar}>
        <div>
          <span style={S.roundLbl}>Round {currentRoundInSet}/{exercises.length}</span>
          {sets > 1 && <span style={{ ...S.roundLbl, marginLeft: 10, color: "#eab308" }}>Set {currentSet}/{sets}</span>}
        </div>
        <div style={{ display: "flex", gap: 6 }}>
          <button onClick={() => setDynamicRing(!dynamicRing)} style={{ ...S.prevToggle, fontSize: 11, padding: "4px 8px", color: dynamicRing ? "#eab308" : "#555" }}>{dynamicRing ? "‚óâ" : "‚óã"}</button>
          <button onClick={() => setPreview(!preview)} style={S.prevToggle}>{preview ? "Hide" : "Preview"}</button>
          <button onClick={() => { setPaused(true); setConfirmAction("home"); }} style={{ ...S.prevToggle, fontSize: 13 }}>‚åÇ</button>
        </div>
      </div>

      {confirmAction === "stop" && <ConfirmModal title="Stop Workout?" message="Your progress will be saved and the workout will end." onConfirm={() => { setConfirmAction(null); handleStop(); }} onCancel={() => { setConfirmAction(null); setPaused(false); }} />}
      {confirmAction === "home" && <ConfirmModal title="Return Home?" message="This will end your workout and return to the home screen." onConfirm={() => { setConfirmAction(null); onStop(); }} onCancel={() => { setConfirmAction(null); setPaused(false); }} />}

      {preview && (
        <div style={S.overlay}><div style={S.modal}>
          <h3 style={S.modalTitle}>Workout Plan{sets > 1 ? ` ¬∑ ${pl(sets, "Set")}` : ""}</h3>
          {exercises.map((x, i) => {
            const isActive = i === globalRound % exercises.length;
            const isPast = i < globalRound % exercises.length;
            return (
              <div key={x.id} style={{ display: "flex", alignItems: "center", gap: 10, padding: "10px 8px", borderRadius: 6, opacity: isPast ? 0.35 : 1, background: isActive ? "rgba(234,179,8,0.1)" : "transparent", borderLeft: isActive ? "3px solid #eab308" : "3px solid transparent" }}>
                <span style={{ fontSize: 12, color: "#737373", width: 20, textAlign: "center" }}>{i + 1}</span>
                <span style={{ flex: 1, fontSize: 14, fontWeight: 600 }}>{x.name}</span>
                <span style={{ fontSize: 12, color: "#a3a3a3" }}>{x.reps}r{x.weight ? ` ¬∑ ${x.weight}kg` : ""}</span>
              </div>
            );
          })}
          <button onClick={() => setPreview(false)} style={S.modalBtn}>Close</button>
        </div></div>
      )}

      <div style={{ textAlign: "center", marginBottom: 8 }}>
        <span style={{ display: "block", fontSize: 22, fontWeight: 700, textTransform: "uppercase", letterSpacing: 2 }}>{currentExercise.name}</span>
        <span style={{ display: "block", fontSize: 14, color: "#eab308", marginTop: 4 }}>{currentExercise.reps} reps{currentExercise.weight ? ` ¬∑ ${currentExercise.weight}kg` : ""}</span>
      </div>

      <div style={{ flex: 1, display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", width: "100%", maxWidth: 260 }}>
        <div style={{ position: "relative", width: "100%", aspectRatio: "1" }}>
          <svg viewBox="0 0 200 200" style={{ width: "100%", height: "100%" }}>
            <circle cx="100" cy="100" r="90" fill="none" stroke="rgba(255,255,255,0.06)" strokeWidth="6" />
            <circle cx="100" cy="100" r="90" fill="none" stroke={ringColor} strokeWidth="6" strokeLinecap="round" strokeDasharray={2 * Math.PI * 90} strokeDashoffset={2 * Math.PI * 90 * (1 - prog)} transform="rotate(-90 100 100)" style={{ transition: "stroke-dashoffset 0.3s linear, stroke 0.5s ease" }} />
          </svg>
          <div style={{ position: "absolute", inset: 0, display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center" }}>
            <span style={{ fontSize: 60, fontWeight: 800, fontVariantNumeric: "tabular-nums", letterSpacing: 4, color: sec <= 10 ? "#ef4444" : "#fafafa" }}>{fmt(sec)}</span>
            <span style={{ fontSize: 14, color: "#737373", fontStyle: "italic", letterSpacing: 3, marginTop: 4, visibility: paused && !confirmAction ? "visible" : "hidden" }}>PAUSED</span>
          </div>
        </div>
      </div>

      <div style={{ display: "flex", gap: 10, marginBottom: 20, alignItems: "center" }}>
        <button onClick={goPrev} disabled={globalRound <= 0} style={{ ...S.skipBtn, opacity: globalRound <= 0 ? 0.25 : 1 }}>‚ü®</button>
        <button onClick={() => setPaused(!paused)} style={S.ctrlBtn}>{paused ? "‚ñ∂ Resume" : "‚ùö‚ùö Pause"}</button>
        <button onClick={() => { setPaused(true); setConfirmAction("stop"); }} style={S.stopBtn}>‚ñ† Stop</button>
        <button onClick={goNext} style={S.skipBtn}>‚ü©</button>
      </div>

      {nextExercise ? (
        <div style={S.upNext}>
          <span style={S.upNextLbl}>Up next</span>
          <span style={S.upNextTxt}>{nextExercise.name} ‚Äî {nextExercise.reps} reps{nextExercise.weight ? ` ¬∑ ${nextExercise.weight}kg` : ""}</span>
        </div>
      ) : (
        <div style={S.upNext}>
          <span style={S.upNextLbl}>Last round</span>
          <span style={S.upNextTxt}>Finish strong üí™</span>
        </div>
      )}

      <div style={{ display: "flex", gap: 16, justifyContent: "center", marginBottom: 4, fontSize: 11, color: "#4a4a4a", fontVariantNumeric: "tabular-nums" }}>
        <span>{fmtElapsed(elapsed)} elapsed</span><span>¬∑</span><span>{totalVol.toLocaleString()}kg vol</span>
      </div>
    </div>
  );
}

function EmomApp() {
  const [exercises, setExercises] = useState([]);
  const [sets, setSets] = useState(1);
  const [running, setRunning] = useState(false);
  const { library, addExercise } = useExerciseLibrary();
  const { workouts, saveWorkout, deleteWorkout } = useSavedWorkouts();
  if (running) return <Timer exercises={exercises} sets={sets} onStop={() => setRunning(false)} />;
  return <WorkoutBuilder exercises={exercises} setExercises={setExercises} sets={sets} setSets={setSets} onStart={() => setRunning(true)} library={library} addExercise={addExercise} savedWorkouts={workouts} saveWorkout={saveWorkout} deleteWorkout={deleteWorkout} />;
}

const S = {
  builder: { minHeight: "100vh", background: "#0a0a0a", color: "#fafafa", padding: "28px 16px 48px", fontFamily: "'JetBrains Mono','SF Mono','Fira Code','Courier New',monospace", maxWidth: 520, margin: "0 auto" },
  logoArea: { textAlign: "center", marginBottom: 28 },
  titleMain: { fontSize: 16, fontWeight: 600, letterSpacing: 4, margin: 0, color: "#a3a3a3", textTransform: "uppercase" },
  titleSub: { fontSize: 32, fontWeight: 800, letterSpacing: 6, margin: "4px 0 0", color: "#eab308" },
  input: { background: "#171717", border: "1px solid #262626", borderRadius: 8, color: "#fafafa", padding: "10px 12px", fontSize: 14, fontFamily: "inherit", outline: "none", width: "100%", boxSizing: "border-box" },
  editLabel: { display: "block", fontSize: 10, color: "#555", letterSpacing: 2, textTransform: "uppercase", marginBottom: 6, textAlign: "center" },
  addRow: { marginBottom: 20 },
  pickersRow: { display: "flex", alignItems: "center", justifyContent: "center", gap: 16, marginTop: 20 },
  addBtn: { background: "#eab308", color: "#0a0a0a", border: "none", borderRadius: 12, width: 52, height: 52, fontSize: 26, fontWeight: 700, cursor: "pointer", flexShrink: 0, alignSelf: "center" },
  dropdown: { position: "absolute", top: "100%", left: 0, right: 0, background: "#1c1c1c", border: "1px solid #333", borderRadius: 8, marginTop: 4, zIndex: 50, overflow: "hidden" },
  ddItem: { padding: "11px 14px", fontSize: 14, cursor: "pointer", borderBottom: "1px solid #1f1f1f" },
  exItem: { display: "flex", alignItems: "center", gap: 10, padding: "11px 0", borderBottom: "1px solid #1a1a1a" },
  roundNum: { width: 26, height: 26, borderRadius: "50%", background: "#262626", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 11, fontWeight: 700, color: "#a3a3a3", flexShrink: 0 },
  microBtn: { background: "none", border: "1px solid #333", borderRadius: 4, color: "#737373", width: 26, height: 26, fontSize: 12, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", padding: 0 },
  statsBar: { background: "#111", borderRadius: 10, padding: "14px 20px", marginTop: 12 },
  statBlock: { display: "inline-flex", alignItems: "baseline", gap: 6 },
  statValue: { fontSize: 22, fontWeight: 800, color: "#fafafa" },
  statLabel: { fontSize: 11, color: "#555", letterSpacing: 1 },
  setsBtn: { width: 40, height: 40, borderRadius: "50%", background: "#171717", border: "1px solid #333", color: "#fafafa", fontSize: 22, fontWeight: 600, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", fontFamily: "inherit", padding: 0 },
  startBtn: { width: "100%", padding: "14px", background: "#eab308", color: "#0a0a0a", border: "none", borderRadius: 10, fontSize: 15, fontWeight: 800, fontFamily: "inherit", letterSpacing: 2, cursor: "pointer" },
  saveLoadRow: { display: "flex", gap: 8, marginTop: 10 },
  secBtn: { flex: 1, padding: "11px 16px", background: "transparent", border: "1px solid #333", borderRadius: 10, color: "#a3a3a3", fontSize: 13, fontWeight: 600, fontFamily: "inherit", cursor: "pointer", letterSpacing: 1 },
  overlay: { position: "fixed", inset: 0, background: "rgba(0,0,0,0.85)", zIndex: 100, display: "flex", alignItems: "center", justifyContent: "center", padding: 20 },
  modal: { background: "#171717", borderRadius: 14, padding: 24, width: "100%", maxWidth: 380, maxHeight: "80vh", overflowY: "auto" },
  modalTitle: { fontSize: 16, fontWeight: 700, letterSpacing: 2, textAlign: "center", margin: "0 0 16px" },
  modalBtn: { width: "100%", marginTop: 16, padding: "10px", background: "#262626", color: "#fafafa", border: "none", borderRadius: 8, fontSize: 13, cursor: "pointer", fontFamily: "inherit" },
  loadItem: { display: "flex", alignItems: "center", gap: 8, padding: "12px 8px", borderBottom: "1px solid #222", cursor: "pointer" },
  timer: { minHeight: "100vh", background: "#0a0a0a", color: "#fafafa", fontFamily: "'JetBrains Mono','SF Mono','Fira Code','Courier New',monospace", display: "flex", flexDirection: "column", alignItems: "center", padding: "20px", position: "relative" },
  topBar: { width: "100%", maxWidth: 420, display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 },
  roundLbl: { fontSize: 13, color: "#a3a3a3", letterSpacing: 1 },
  prevToggle: { background: "none", border: "1px solid #333", borderRadius: 6, color: "#a3a3a3", fontSize: 12, padding: "5px 12px", cursor: "pointer", fontFamily: "inherit" },
  ctrlBtn: { background: "#262626", color: "#fafafa", border: "none", borderRadius: 10, padding: "12px 24px", fontSize: 14, fontWeight: 600, cursor: "pointer", fontFamily: "inherit" },
  stopBtn: { background: "transparent", color: "#ef4444", border: "1px solid #ef4444", borderRadius: 10, padding: "12px 24px", fontSize: 14, fontWeight: 600, cursor: "pointer", fontFamily: "inherit" },
  skipBtn: { background: "none", border: "1px solid #333", borderRadius: 10, color: "#a3a3a3", width: 40, height: 44, fontSize: 18, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center", fontFamily: "inherit", padding: 0 },
  upNext: { background: "#141414", borderRadius: 10, padding: "14px 20px", width: "100%", maxWidth: 420, textAlign: "center", marginBottom: 10 },
  upNextLbl: { display: "block", fontSize: 10, letterSpacing: 3, color: "#737373", textTransform: "uppercase", marginBottom: 4 },
  upNextTxt: { fontSize: 14, color: "#d4d4d4" },
  finArea: { flex: 1, display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center", textAlign: "center" },
  finTitle: { fontSize: 24, fontWeight: 800, letterSpacing: 3, margin: "0 0 12px" },
};

ReactDOM.createRoot(document.getElementById("root")).render(<EmomApp />);
</script>
</body>
</html>
